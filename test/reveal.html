<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Reveal</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;600;700&family=DM+Mono:wght@400;500&display=swap');

  :root {
    --bg: #0a0a0b;
    --surface: #111114;
    --surface2: #18181c;
    --border: #2a2a30;
    --gold: #c9a84c;
    --gold-dim: #7a6030;
    --text: #e8e4dc;
    --text-dim: #6b6860;
    --red: #c0392b;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Mono', monospace;
    min-height: 100dvh;
    overflow-x: hidden;
  }

  /* ‚îÄ‚îÄ SETUP SCREEN ‚îÄ‚îÄ */
  #setupScreen {
    max-width: 680px;
    margin: 0 auto;
    padding: 40px 20px 60px;
  }

  .brand {
    text-align: center;
    margin-bottom: 44px;
  }
  .brand h1 {
    font-family: 'Cormorant Garamond', serif;
    font-size: 52px;
    font-weight: 300;
    letter-spacing: 8px;
    text-transform: uppercase;
    color: var(--gold);
    line-height: 1;
  }
  .brand p {
    font-size: 11px;
    color: var(--text-dim);
    letter-spacing: 3px;
    text-transform: uppercase;
    margin-top: 8px;
  }

  .section {
    margin-bottom: 28px;
  }
  .section-label {
    font-size: 10px;
    letter-spacing: 3px;
    text-transform: uppercase;
    color: var(--gold-dim);
    margin-bottom: 10px;
    padding-left: 2px;
  }

  /* Upload zones */
  .upload-zone {
    border: 1px dashed var(--border);
    border-radius: 12px;
    padding: 30px 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    background: var(--surface);
  }
  .upload-zone:hover { border-color: var(--gold-dim); background: var(--surface2); }
  .upload-zone.has-file { border-color: var(--gold); border-style: solid; }
  .upload-zone input[type="file"] { display: none; }
  .upload-icon { font-size: 28px; margin-bottom: 8px; opacity: 0.5; }
  .upload-label { font-size: 13px; color: var(--text-dim); }
  .upload-label strong { color: var(--text); display: block; margin-bottom: 4px; font-size: 14px; }
  .upload-badge {
    display: inline-block;
    background: var(--gold);
    color: #000;
    font-size: 10px;
    font-weight: 500;
    padding: 3px 8px;
    border-radius: 20px;
    margin-top: 8px;
    letter-spacing: 1px;
    text-transform: uppercase;
  }

  /* Board preview + marker */
  #boardPreviewWrap {
    display: none;
    margin-top: 14px;
  }
  .preview-hint {
    font-size: 11px;
    color: var(--gold);
    letter-spacing: 2px;
    text-transform: uppercase;
    text-align: center;
    margin-bottom: 8px;
    opacity: 0.9;
  }
  #boardPreview {
    width: 100%;
    border-radius: 10px;
    display: block;
    cursor: crosshair;
    border: 1px solid var(--border);
    position: relative;
  }
  .marker-dot {
    position: absolute;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: 2px solid var(--gold);
    background: rgba(201,168,76,0.25);
    transform: translate(-50%, -50%);
    pointer-events: none;
    display: none;
  }
  .marker-dot::after {
    content: '';
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%,-50%);
    width: 6px; height: 6px;
    background: var(--gold);
    border-radius: 50%;
  }
  #boardPreviewContainer {
    position: relative;
    display: inline-block;
    width: 100%;
  }

  /* Style row */
  .style-row {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 10px;
  }
  .style-field label {
    display: block;
    font-size: 10px;
    color: var(--text-dim);
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-bottom: 6px;
  }
  .style-field input[type="text"],
  .style-field input[type="number"],
  .style-field select {
    width: 100%;
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 10px 12px;
    border-radius: 8px;
    font-family: 'DM Mono', monospace;
    font-size: 14px;
    outline: none;
    transition: border-color 0.2s;
  }
  .style-field input:focus,
  .style-field select:focus { border-color: var(--gold-dim); }
  .style-field input[type="color"] {
    width: 100%;
    height: 42px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    cursor: pointer;
    padding: 3px;
  }
  select option { background: #1a1a1e; }

  /* Divider */
  .divider {
    border: none;
    border-top: 1px solid var(--border);
    margin: 32px 0;
  }

  /* Number input */
  #numberInput {
    width: 100%;
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--gold);
    padding: 18px 20px;
    border-radius: 12px;
    font-family: 'Cormorant Garamond', serif;
    font-size: 36px;
    font-weight: 600;
    text-align: center;
    outline: none;
    letter-spacing: 4px;
    transition: border-color 0.2s;
  }
  #numberInput:focus { border-color: var(--gold); }
  #numberInput::placeholder { color: var(--border); font-size: 24px; letter-spacing: 2px; }

  /* Reveal style selector */
  .reveal-options {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin-top: 10px;
  }
  .reveal-opt {
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text-dim);
    border-radius: 8px;
    padding: 10px 6px;
    text-align: center;
    cursor: pointer;
    font-size: 11px;
    letter-spacing: 1px;
    text-transform: uppercase;
    transition: all 0.2s;
  }
  .reveal-opt.active { border-color: var(--gold); color: var(--gold); background: rgba(201,168,76,0.08); }
  .reveal-opt .opt-icon { font-size: 18px; display: block; margin-bottom: 4px; }

  /* Launch button */
  #launchBtn {
    width: 100%;
    margin-top: 30px;
    padding: 20px;
    background: var(--gold);
    color: #000;
    border: none;
    border-radius: 12px;
    font-family: 'Cormorant Garamond', serif;
    font-size: 22px;
    font-weight: 700;
    letter-spacing: 4px;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.2s;
  }
  #launchBtn:hover { background: #dbb85a; transform: translateY(-1px); }
  #launchBtn:disabled { background: var(--border); color: var(--text-dim); cursor: not-allowed; transform: none; }

  .req-note {
    font-size: 11px;
    color: var(--text-dim);
    text-align: center;
    margin-top: 12px;
    line-height: 1.6;
  }
  .req-dot { display: inline-block; width: 6px; height: 6px; border-radius: 50%; background: var(--border); margin-right: 6px; vertical-align: middle; }
  .req-dot.ok { background: #2ecc71; }

  /* ‚îÄ‚îÄ PERFORMANCE SCREEN ‚îÄ‚îÄ */
  #performScreen {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: #000;
    z-index: 100;
    align-items: center;
    justify-content: center;
  }

  #actVideo {
    max-width: 100%;
    max-height: 100dvh;
    width: auto;
    height: auto;
    object-fit: contain;
    display: none;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 5;
  }

  #revealCanvas {
    max-width: 100%;
    max-height: 100dvh;
    width: auto;
    height: auto;
    display: block;   /* always in DOM ‚Äî z-index hides it during act */
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    image-rendering: -webkit-optimize-contrast;
    image-rendering: crisp-edges;
    z-index: 2;       /* below act video (z-index 5) during pre-roll */
  }

  /* Tap-to-start overlay */
  #tapOverlay {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,0.92);
    cursor: pointer;
    z-index: 10;
  }
  .tap-number {
    font-family: 'Cormorant Garamond', serif;
    font-size: clamp(72px, 20vw, 160px);
    font-weight: 600;
    color: var(--gold);
    line-height: 1;
    letter-spacing: 8px;
    text-shadow: 0 0 60px rgba(201,168,76,0.3);
  }
  .tap-hint {
    font-size: 12px;
    letter-spacing: 4px;
    text-transform: uppercase;
    color: var(--text-dim);
    margin-top: 24px;
  }
  .tap-subhint {
    font-size: 10px;
    letter-spacing: 3px;
    text-transform: uppercase;
    color: #333;
    margin-top: 10px;
  }

  /* Exit button */
  #exitBtn {
    position: absolute;
    top: 16px; right: 16px;
    background: rgba(0,0,0,0.6);
    border: 1px solid var(--border);
    color: var(--text-dim);
    padding: 8px 14px;
    border-radius: 8px;
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    letter-spacing: 2px;
    cursor: pointer;
    z-index: 20;
    text-transform: uppercase;
    opacity: 0;
    transition: opacity 0.3s;
  }
  #exitBtn.visible { opacity: 1; }

  /* Progress bar */
  #progressBar {
    position: absolute;
    bottom: 0; left: 0;
    height: 2px;
    background: var(--gold);
    width: 0%;
    transition: width 0.5s linear;
    z-index: 20;
    opacity: 0.5;
  }

  /* Crossfade overlay ‚Äî replaces hard flash */
  #flashOverlay {
    position: absolute;
    inset: 0;
    background: #000;
    opacity: 0;
    pointer-events: none;
    z-index: 15;
    transition: opacity 0.3s ease;
  }

  /* ‚îÄ‚îÄ PLAYER CONTROLS ‚îÄ‚îÄ */
  #playerControls {
    position: absolute;
    bottom: 0; left: 0; right: 0;
    z-index: 25;
    background: linear-gradient(transparent, rgba(0,0,0,0.75));
    padding: 30px 20px 20px;
    display: none;
    flex-direction: column;
    gap: 10px;
    opacity: 0;
    transition: opacity 0.25s;
  }
  #playerControls.visible { opacity: 1; }

  .scrub-row {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  #scrubber {
    flex: 1;
    -webkit-appearance: none;
    appearance: none;
    height: 3px;
    border-radius: 3px;
    background: rgba(255,255,255,0.25);
    outline: none;
    cursor: pointer;
    accent-color: var(--gold);
  }
  #scrubber::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 14px; height: 14px;
    border-radius: 50%;
    background: var(--gold);
    cursor: pointer;
  }
  .time-label {
    font-size: 12px;
    color: rgba(255,255,255,0.6);
    font-family: 'DM Mono', monospace;
    min-width: 44px;
    text-align: right;
  }
  .ctrl-row {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 20px;
  }
  .ctrl-btn {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    padding: 8px;
    font-size: 22px;
    opacity: 0.85;
    transition: opacity 0.15s, transform 0.1s;
    line-height: 1;
  }
  .ctrl-btn:hover { opacity: 1; transform: scale(1.1); }
  .ctrl-btn.play-btn { font-size: 32px; }

  /* Transition selector pill */
  #transitionPill {
    position: absolute;
    top: 16px; left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.65);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 20px;
    padding: 6px 14px;
    display: none;
    align-items: center;
    gap: 8px;
    z-index: 25;
    backdrop-filter: blur(8px);
    white-space: nowrap;
  }
  #transitionPill label {
    font-size: 10px;
    color: rgba(255,255,255,0.4);
    letter-spacing: 2px;
    text-transform: uppercase;
  }
  #transitionSelect {
    background: transparent;
    border: none;
    color: var(--gold);
    font-family: 'DM Mono', monospace;
    font-size: 12px;
    outline: none;
    cursor: pointer;
  }
  #transitionSelect option { background: #111; }
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SETUP SCREEN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="setupScreen">

  <div class="brand">
    <h1>Reveal</h1>
    <p>Mentalism Performance Tool</p>
  </div>

  <!-- STEP 1 ‚Äî Performance video -->
  <div class="section">
    <div class="section-label">Step 1 ‚Äî Performance Video</div>
    <div class="upload-zone" id="actZone" onclick="document.getElementById('actFile').click()">
      <input type="file" id="actFile" accept="video/*" onchange="loadActVideo(this)">
      <div class="upload-icon">üé¨</div>
      <div class="upload-label">
        <strong>Your Act Video</strong>
        The full performance ‚Äî talking to the audience member, building suspense, stepping away.
      </div>
      <div id="actBadge" style="display:none" class="upload-badge">‚úì Loaded</div>
    </div>
  </div>

  <!-- STEP 2 ‚Äî Board video + position marker -->
  <div class="section">
    <div class="section-label">Step 2 ‚Äî Board Reveal Video</div>
    <div class="upload-zone" id="boardZone" onclick="document.getElementById('boardFile').click()">
      <input type="file" id="boardFile" accept="video/*" onchange="loadBoardVideo(this)">
      <div class="upload-icon">ü™Ñ</div>
      <div class="upload-label">
        <strong>The Board Clip</strong>
        Short clip (3‚Äì8 sec) of you stepping away from the blank board. The number will be composited onto this.
      </div>
      <div id="boardBadge" style="display:none" class="upload-badge">‚úì Loaded ‚Äî tap preview to mark position</div>
    </div>

    <div id="boardPreviewWrap">
      <div class="preview-hint">‚Üì Tap the board to mark where your number appears</div>
      <div id="boardPreviewContainer">
        <video id="boardPreview" muted playsinline loop></video>
        <div class="marker-dot" id="markerDot"></div>
      </div>
      <div style="font-size:11px; color:var(--text-dim); margin-top:8px; text-align:center;" id="positionReadout">Position not set</div>
    </div>
  </div>

  <!-- STEP 3 ‚Äî Number appearance style -->
  <div class="section">
    <div class="section-label">Step 3 ‚Äî Number Style</div>
    <div class="style-row">
      <div class="style-field">
        <label>Color</label>
        <input type="color" id="numColor" value="#ffffff">
      </div>
      <div class="style-field">
        <label>Size (px)</label>
        <input type="number" id="numSize" value="120" min="20" max="500">
      </div>
      <div class="style-field">
        <label>Font</label>
        <select id="numFont">
          <option value="sans-serif">Sans</option>
          <option value="serif">Serif</option>
          <option value="'Courier New', monospace">Mono</option>
          <option value="Impact, sans-serif">Impact</option>
          <option value="'Georgia', serif" selected>Georgia</option>
          <option value="'Arial Black', sans-serif">Bold</option>
        </select>
      </div>
    </div>

    <!-- Shadow / outline options -->
    <div class="style-row" style="margin-top:10px;">
      <div class="style-field">
        <label>Shadow</label>
        <select id="numShadow">
          <option value="none">None</option>
          <option value="dark" selected>Dark drop</option>
          <option value="glow">Glow</option>
          <option value="outline">Outline</option>
        </select>
      </div>
      <div class="style-field">
        <label>Reveal Effect</label>
        <select id="revealEffect">
          <option value="instant">Instant</option>
          <option value="fade" selected>Fade In</option>
          <option value="scale">Scale Up</option>
          <option value="glow">Glow Pulse</option>
        </select>
      </div>
      <div class="style-field">
        <label>Reveal At</label>
        <select id="revealTiming">
          <option value="0">Immediately</option>
          <option value="0.5" selected>0.5s in</option>
          <option value="1">1s in</option>
          <option value="1.5">1.5s in</option>
          <option value="2">2s in</option>
        </select>
      </div>
    </div>
  </div>

  <hr class="divider">

  <!-- STEP 4 ‚Äî The number -->
  <div class="section">
    <div class="section-label">Step 4 ‚Äî Their Number</div>
    <input type="text" id="numberInput" placeholder="e.g.  47" maxlength="12" autocomplete="off" spellcheck="false">
    <div style="font-size:11px; color:var(--text-dim); margin-top:8px; text-align:center; letter-spacing:1px;">Enter this right before performance, or during the act</div>
  </div>

  <!-- Status dots -->
  <div class="req-note">
    <span id="dot1" class="req-dot"></span> Act video &nbsp;¬∑&nbsp;
    <span id="dot2" class="req-dot"></span> Board video &nbsp;¬∑&nbsp;
    <span id="dot3" class="req-dot"></span> Position marked &nbsp;¬∑&nbsp;
    <span id="dot4" class="req-dot"></span> Number entered
  </div>

  <button id="launchBtn" onclick="launchPerformance()" disabled>
    Perform
  </button>

  <div style="text-align:center; margin-top:20px;">
    <span id="storageInfo" style="font-size:11px; color:var(--text-dim); letter-spacing:1px;"></span>
    <br><br>
    <span onclick="clearStoredVideos()" style="font-size:11px; color:var(--gold-dim); letter-spacing:2px; text-transform:uppercase; cursor:pointer; text-decoration:underline; text-underline-offset:3px;">Clear saved videos</span>
  </div>

</div>


<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     PERFORMANCE SCREEN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="performScreen">

  <!-- Tap-to-start overlay -->
  <div id="tapOverlay" onclick="startAct()">
    <div class="tap-number" id="tapNumber">‚Äî</div>
    <div class="tap-hint">Tap anywhere to begin</div>
    <div class="tap-subhint">Your number is locked in</div>
  </div>

  <!-- Act video plays here -->
  <video id="actVideo" playsinline></video>

  <!-- Canvas for composited reveal -->
  <canvas id="revealCanvas"></canvas>

  <!-- Crossfade overlay -->
  <div id="flashOverlay"></div>

  <!-- Transition style selector (top center) -->
  <div id="transitionPill">
    <label>Transition</label>
    <select id="transitionSelect">
      <option value="cut">Hard Cut</option>
      <option value="fade" selected>Fade (0.3s)</option>
      <option value="fade-slow">Fade (0.8s)</option>
      <option value="fade-slow2">Fade (1.5s)</option>
    </select>
  </div>

  <!-- Player Controls -->
  <div id="playerControls">
    <div class="scrub-row">
      <span class="time-label" id="timeDisplay">0:00</span>
      <input type="range" id="scrubber" min="0" max="100" value="0" step="0.1"
             oninput="onScrub(this.value)" onmousedown="scrubbing=true" onmouseup="onScrubEnd()" ontouchend="onScrubEnd()">
      <span class="time-label" id="durationDisplay">0:00</span>
    </div>
    <div class="ctrl-row">
      <button class="ctrl-btn" onclick="restartPerformance()" title="Restart">‚Ü∫</button>
      <button class="ctrl-btn play-btn" id="playPauseBtn" onclick="togglePlayPause()">‚è∏</button>
      <button class="ctrl-btn" onclick="exitPerformance()" title="Exit">‚úï</button>
    </div>
  </div>

</div>

<!-- Hidden board video for compositing -->
<video id="boardVideoEl" style="display:none" playsinline></video>


<script>
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// STATE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let actURL = null;
let boardURL = null;
let markerX = null;
let markerY = null;
let animFrameId = null;
let revealStartTime = null;
let numberOpacity = 0;
let scaleVal = 1;
let db = null;

// Player state
let currentPhase = 'act'; // 'act' | 'reveal'
let isPaused = false;
let scrubbing = false;
let controlsTimeout = null;
let totalDuration = 0;   // act duration + board duration
let actDuration = 0;
let boardDuration = 0;

const actVideoEl   = document.getElementById('actVideo');
const boardVideoEl = document.getElementById('boardVideoEl');
const revealCanvas = document.getElementById('revealCanvas');
const ctx = revealCanvas.getContext('2d');

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// INDEXEDDB SETUP
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open('RevealApp', 1);
    req.onupgradeneeded = e => {
      const d = e.target.result;
      if (!d.objectStoreNames.contains('videos'))   d.createObjectStore('videos');
      if (!d.objectStoreNames.contains('settings')) d.createObjectStore('settings');
    };
    req.onsuccess = e => resolve(e.target.result);
    req.onerror   = e => reject(e.target.error);
  });
}

function dbSet(storeName, key, value) {
  return new Promise((resolve, reject) => {
    const tx  = db.transaction(storeName, 'readwrite');
    const req = tx.objectStore(storeName).put(value, key);
    req.onsuccess = () => resolve();
    req.onerror   = e => reject(e.target.error);
  });
}

function dbGet(storeName, key) {
  return new Promise((resolve, reject) => {
    const tx  = db.transaction(storeName, 'readonly');
    const req = tx.objectStore(storeName).get(key);
    req.onsuccess = e => resolve(e.target.result);
    req.onerror   = e => reject(e.target.error);
  });
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// SAVE & LOAD SETTINGS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function saveSettings() {
  if (!db) return;
  const settings = {
    markerX,
    markerY,
    numColor:     document.getElementById('numColor').value,
    numSize:      document.getElementById('numSize').value,
    numFont:      document.getElementById('numFont').value,
    numShadow:    document.getElementById('numShadow').value,
    revealEffect: document.getElementById('revealEffect').value,
    revealTiming: document.getElementById('revealTiming').value,
  };
  await dbSet('settings', 'prefs', settings);
}

async function loadSettings() {
  if (!db) return;
  const s = await dbGet('settings', 'prefs');
  if (!s) return;
  if (s.markerX !== null && s.markerX !== undefined) {
    markerX = s.markerX;
    markerY = s.markerY;
    const dot = document.getElementById('markerDot');
    dot.style.left    = (markerX * 100) + '%';
    dot.style.top     = (markerY * 100) + '%';
    dot.style.display = 'block';
    document.getElementById('positionReadout').innerText =
      `Position set ‚Äî ${Math.round(markerX*100)}% from left, ${Math.round(markerY*100)}% from top`;
  }
  if (s.numColor)     document.getElementById('numColor').value     = s.numColor;
  if (s.numSize)      document.getElementById('numSize').value      = s.numSize;
  if (s.numFont)      document.getElementById('numFont').value      = s.numFont;
  if (s.numShadow)    document.getElementById('numShadow').value    = s.numShadow;
  if (s.revealEffect) document.getElementById('revealEffect').value = s.revealEffect;
  if (s.revealTiming) document.getElementById('revealTiming').value = s.revealTiming;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// SAVE & LOAD VIDEOS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function saveVideo(key, file) {
  if (!db || !file) return;
  const buf = await file.arrayBuffer();
  await dbSet('videos', key, { buffer: buf, type: file.type, name: file.name });
}

async function loadVideoFromDB(key) {
  if (!db) return null;
  const record = await dbGet('videos', key);
  if (!record) return null;
  const blob = new Blob([record.buffer], { type: record.type });
  return { url: URL.createObjectURL(blob), name: record.name };
}

function setStoredLabel(zoneId, badgeId, name) {
  document.getElementById(zoneId).classList.add('has-file');
  const badge = document.getElementById(badgeId);
  badge.style.display = 'inline-block';
  badge.innerText = `‚úì ${name}`;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// INIT ‚Äî restore everything on load
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function initApp() {
  db = await openDB();
  await loadSettings();

  // Restore act video
  const act = await loadVideoFromDB('act');
  if (act) {
    if (actURL) URL.revokeObjectURL(actURL);
    actURL = act.url;
    actVideoEl.src = actURL;
    actVideoEl.load();
    actVideoEl.onended = handleActEnd;
    actVideoEl.ontimeupdate = updateProgress;
    setStoredLabel('actZone', 'actBadge', act.name);
  }

  // Restore board video
  const board = await loadVideoFromDB('board');
  if (board) {
    if (boardURL) URL.revokeObjectURL(boardURL);
    boardURL = board.url;
    setupBoardPreview(boardURL);
    setStoredLabel('boardZone', 'boardBadge', board.name);
    document.getElementById('boardBadge').innerText = `‚úì ${board.name} ‚Äî tap preview to adjust position`;
    document.getElementById('boardPreviewWrap').style.display = 'block';
  }

  updateDots();
  updateStorageInfo();
}

function setupBoardPreview(url) {
  const preview = document.getElementById('boardPreview');
  preview.src = url;
  preview.load();
  preview.play().catch(()=>{});
  preview.onclick = markPosition;
  boardVideoEl.src = url;
  boardVideoEl.load();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// UPLOAD HANDLERS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadActVideo(input) {
  if (!input.files[0]) return;
  const file = input.files[0];
  if (actURL) URL.revokeObjectURL(actURL);
  actURL = URL.createObjectURL(file);
  actVideoEl.src = actURL;
  actVideoEl.load();
  actVideoEl.onended = handleActEnd;
  actVideoEl.ontimeupdate = updateProgress;
  setStoredLabel('actZone', 'actBadge', file.name);
  updateDots();

  // Save to DB (show saving indicator)
  document.getElementById('actBadge').innerText = '‚è≥ Saving‚Ä¶';
  await saveVideo('act', file);
  document.getElementById('actBadge').innerText = `‚úì ${file.name}`;
}

async function loadBoardVideo(input) {
  if (!input.files[0]) return;
  const file = input.files[0];
  if (boardURL) URL.revokeObjectURL(boardURL);
  boardURL = URL.createObjectURL(file);
  setupBoardPreview(boardURL);
  setStoredLabel('boardZone', 'boardBadge', file.name);
  document.getElementById('boardBadge').innerText = `‚úì ${file.name} ‚Äî tap preview to mark position`;
  document.getElementById('boardPreviewWrap').style.display = 'block';
  updateDots();

  // Save to DB
  document.getElementById('boardBadge').innerText = '‚è≥ Saving‚Ä¶';
  await saveVideo('board', file);
  document.getElementById('boardBadge').innerText = `‚úì ${file.name} ‚Äî tap preview to adjust position`;
}

function markPosition(e) {
  const preview = document.getElementById('boardPreview');
  const rect = preview.getBoundingClientRect();
  const dot  = document.getElementById('markerDot');

  markerX = (e.clientX - rect.left) / rect.width;
  markerY = (e.clientY - rect.top) / rect.height;

  // Position the dot visually
  dot.style.left = (markerX * 100) + '%';
  dot.style.top  = (markerY * 100) + '%';
  dot.style.display = 'block';

  document.getElementById('positionReadout').innerText =
    `Position set ‚Äî ${Math.round(markerX*100)}% from left, ${Math.round(markerY*100)}% from top`;

  updateDots();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// STATUS DOTS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateDots() {
  const d = (id, ok) => document.getElementById(id).className = 'req-dot' + (ok ? ' ok' : '');
  const num = document.getElementById('numberInput').value.trim();
  d('dot1', !!actURL);
  d('dot2', !!boardURL);
  d('dot3', markerX !== null);
  d('dot4', num.length > 0);

  const ready = actURL && boardURL && markerX !== null && num.length > 0;
  document.getElementById('launchBtn').disabled = !ready;
}
document.getElementById('numberInput').addEventListener('input', updateDots);

// Auto-save settings when any style field changes
['numColor','numSize','numFont','numShadow','revealEffect','revealTiming'].forEach(id => {
  document.getElementById(id).addEventListener('change', saveSettings);
});

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// LAUNCH
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function launchPerformance() {
  const num = document.getElementById('numberInput').value.trim();
  if (!num) return;

  // Show performance screen
  document.getElementById('setupScreen').style.display = 'none';
  const ps = document.getElementById('performScreen');
  ps.style.display = 'flex';

  // Show tap overlay with the number
  document.getElementById('tapNumber').innerText = num;

  // Request fullscreen
  ps.requestFullscreen && ps.requestFullscreen().catch(()=>{});

  // Show exit button after 2s
  setTimeout(() => document.getElementById('exitBtn').classList.add('visible'), 2000);

  // Pre-load board video
  boardVideoEl.load();
}

let preRollDone = false;

function startAct() {
  document.getElementById('tapOverlay').style.display = 'none';
  actVideoEl.style.display = 'block';
  currentPhase = 'act';
  isPaused = false;
  scrubbing = false;
  preRollDone = false;

  // Capture durations
  function onActMeta() {
    actDuration = actVideoEl.duration || 0;
    totalDuration = actDuration + boardDuration;
    document.getElementById('durationDisplay').innerText = formatTime(totalDuration);
    document.getElementById('scrubber').max = totalDuration;
  }
  if (actVideoEl.readyState >= 1) onActMeta();
  else actVideoEl.onloadedmetadata = onActMeta;

  if (boardVideoEl.readyState >= 1) {
    boardDuration = boardVideoEl.duration || 0;
  } else {
    boardVideoEl.onloadedmetadata = () => {
      boardDuration = boardVideoEl.duration || 0;
      totalDuration = actDuration + boardDuration;
      document.getElementById('durationDisplay').innerText = formatTime(totalDuration);
      document.getElementById('scrubber').max = totalDuration;
    };
  }

  // Pre-roll: size canvas and start board drawing BEFORE act ends
  // Canvas stays z-index below act video so it's invisible to viewer
  function maybePreRoll() {
    if (preRollDone || scrubbing || isPaused) return;
    if (!actVideoEl.duration) return;
    const remaining = actVideoEl.duration - actVideoEl.currentTime;
    if (remaining <= 0.7) {
      preRollDone = true;
      primeBoard();
    }
  }

  // Wire the timeupdate for both scrubber sync and pre-roll trigger
  actVideoEl.ontimeupdate = () => {
    updateProgress();
    maybePreRoll();
  };

  actVideoEl.play();
  document.getElementById('playerControls').style.display = 'flex';
  document.getElementById('transitionPill').style.display = 'flex';
  document.getElementById('playPauseBtn').innerText = '‚è∏';
  showControls();
}

function primeBoard() {
  // Set canvas dimensions from board video's real resolution
  const vw = boardVideoEl.videoWidth;
  const vh = boardVideoEl.videoHeight;
  if (vw && vh) {
    revealCanvas.width  = vw;
    revealCanvas.height = vh;
  }
  fitCanvas();

  // Reset compositor state ‚Äî number hidden until act actually ends
  revealStartTime = null;
  numberOpacity   = 0;
  scaleVal        = 0.6;

  // Seek to frame 0 and start playing into canvas ‚Äî canvas is still
  // visually behind the act video (z-index), so viewer sees nothing yet
  boardVideoEl.currentTime = 0;
  boardVideoEl.loop = false;
  boardVideoEl.onended = () => { /* freeze on last frame */ };
  boardVideoEl.ontimeupdate = updateProgress;

  // Start draw loop immediately ‚Äî paints board frames onto hidden canvas
  cancelAnimationFrame(animFrameId);
  drawReveal();

  boardVideoEl.play().catch(() => {});
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// PROGRESS BAR
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateProgress() {
  if (scrubbing) return;
  const current = currentPhase === 'act'
    ? actVideoEl.currentTime
    : actDuration + boardVideoEl.currentTime;
  document.getElementById('scrubber').value = current;
  document.getElementById('timeDisplay').innerText = formatTime(current);
  if (totalDuration) {
    document.getElementById('durationDisplay').innerText = formatTime(totalDuration);
  }
}

function formatTime(s) {
  if (!isFinite(s)) return '0:00';
  const m = Math.floor(s / 60);
  const sec = Math.floor(s % 60).toString().padStart(2, '0');
  return m + ':' + sec;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// TRANSITION FROM ACT ‚Üí REVEAL
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function handleActEnd() {
  currentPhase = 'reveal';
  const mode = document.getElementById('transitionSelect').value;
  const flash = document.getElementById('flashOverlay');
  totalDuration = actDuration + boardDuration;

  // If pre-roll didn't fire (very short act video), prime now
  if (!preRollDone) {
    preRollDone = true;
    primeBoard();
  }

  function swapToCanvas() {
    // Board already running on canvas behind act video ‚Äî just hide act video
    actVideoEl.style.display = 'none';
    revealCanvas.style.zIndex = '5';  // now on top
    fitCanvas();
    // Unblock the number reveal animation from this moment
    revealStartTime = null;
    flash.style.opacity = '0';
  }

  if (mode === 'cut') {
    swapToCanvas();
  } else {
    const dur = mode === 'fade' ? 300 : mode === 'fade-slow' ? 800 : 1500;
    const half = dur / 2;
    flash.style.transition = `opacity ${half}ms ease`;
    flash.style.opacity = '1';
    setTimeout(() => {
      swapToCanvas();
      flash.style.transition = `opacity ${half}ms ease`;
    }, half);
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// CANVAS COMPOSITING
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawReveal(timestamp) {
  const num      = document.getElementById('numberInput').value.trim();
  const color    = document.getElementById('numColor').value;
  const size     = parseInt(document.getElementById('numSize').value) || 120;
  const font     = document.getElementById('numFont').value;
  const shadow   = document.getElementById('numShadow').value;
  const effect   = document.getElementById('revealEffect').value;
  const revealAt = parseFloat(document.getElementById('revealTiming').value);

  // Init timestamp
  if (!revealStartTime) revealStartTime = timestamp;
  const elapsed = (timestamp - revealStartTime) / 1000; // seconds

  // Draw board video frame
  if (boardVideoEl.readyState >= 2) {
    ctx.drawImage(boardVideoEl, 0, 0, revealCanvas.width, revealCanvas.height);
  } else {
    ctx.fillStyle = '#000';
    ctx.fillRect(0, 0, revealCanvas.width, revealCanvas.height);
  }

  // Compute number position in canvas pixels
  const px = markerX * revealCanvas.width;
  const py = markerY * revealCanvas.height;

  // Compute opacity / scale based on effect
  const revealElapsed = elapsed - revealAt;

  if (revealElapsed > 0) {
    const t = Math.min(revealElapsed / 0.6, 1); // 0.6s transition

    if (effect === 'instant') {
      numberOpacity = 1;
      scaleVal = 1;
    } else if (effect === 'fade') {
      numberOpacity = t;
      scaleVal = 1;
    } else if (effect === 'scale') {
      numberOpacity = t;
      scaleVal = 0.4 + (0.6 * t);
    } else if (effect === 'glow') {
      numberOpacity = 1;
      scaleVal = 1;
      // glow pulses
      const pulse = 1 + 0.06 * Math.sin(elapsed * 8);
      scaleVal = t < 1 ? (0.5 + 0.5 * t) * pulse : pulse;
    }
  } else {
    numberOpacity = 0;
  }

  if (numberOpacity > 0) {
    ctx.save();
    ctx.globalAlpha = numberOpacity;
    ctx.translate(px, py);
    ctx.scale(scaleVal, scaleVal);

    ctx.font = `${size}px ${font}`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';

    // Shadow / outline
    if (shadow === 'dark') {
      ctx.shadowColor = 'rgba(0,0,0,0.9)';
      ctx.shadowBlur = size * 0.15;
      ctx.shadowOffsetX = size * 0.04;
      ctx.shadowOffsetY = size * 0.04;
    } else if (shadow === 'glow') {
      ctx.shadowColor = color;
      ctx.shadowBlur = size * 0.4;
    } else if (shadow === 'outline') {
      ctx.strokeStyle = '#000';
      ctx.lineWidth = size * 0.06;
      ctx.lineJoin = 'round';
      ctx.strokeText(num, 0, 0);
    }

    ctx.fillStyle = color;
    ctx.fillText(num, 0, 0);

    ctx.restore();
  }

  animFrameId = requestAnimationFrame(drawReveal);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// EXIT
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// PLAYER CONTROLS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showControls() {
  const ctrl = document.getElementById('playerControls');
  ctrl.style.display = 'flex';
  ctrl.classList.add('visible');
  clearTimeout(controlsTimeout);
  // Auto-hide after 3s unless paused
  controlsTimeout = setTimeout(() => {
    if (!isPaused) ctrl.classList.remove('visible');
  }, 3000);
}

function togglePlayPause() {
  isPaused = !isPaused;
  const btn = document.getElementById('playPauseBtn');
  if (isPaused) {
    btn.innerText = '‚ñ∂';
    if (currentPhase === 'act') actVideoEl.pause();
    else boardVideoEl.pause();
  } else {
    btn.innerText = '‚è∏';
    if (currentPhase === 'act') actVideoEl.play();
    else boardVideoEl.play();
    showControls();
  }
}

function restartPerformance() {
  cancelAnimationFrame(animFrameId);
  boardVideoEl.pause();
  boardVideoEl.currentTime = 0;
  actVideoEl.pause();
  actVideoEl.currentTime = 0;
  revealCanvas.style.zIndex = '2';  // back below act video
  document.getElementById('flashOverlay').style.opacity = '0';
  actVideoEl.style.display = 'block';
  currentPhase = 'act';
  isPaused = false;
  preRollDone = false;
  revealStartTime = null;
  numberOpacity = 0;
  scaleVal = 0.6;
  document.getElementById('playPauseBtn').innerText = '‚è∏';
  document.getElementById('scrubber').value = 0;
  document.getElementById('timeDisplay').innerText = '0:00';
  actVideoEl.play();
  showControls();
}

function onScrub(val) {
  scrubbing = true;
  const t = parseFloat(val);
  document.getElementById('timeDisplay').innerText = formatTime(t);
  // Visual feedback while dragging
}

function onScrubEnd() {
  const t = parseFloat(document.getElementById('scrubber').value);
  scrubbing = false;

  if (t <= actDuration) {
    // Scrubbing into act video
    if (currentPhase === 'reveal') {
      // Switch back to act video
      cancelAnimationFrame(animFrameId);
      boardVideoEl.pause();
      revealCanvas.style.display = 'none';
      actVideoEl.style.display = 'block';
      currentPhase = 'act';
      document.getElementById('flashOverlay').style.opacity = '0';
    }
    actVideoEl.currentTime = t;
    if (!isPaused) actVideoEl.play();
  } else {
    // Scrubbing into reveal
    const boardT = t - actDuration;
    if (currentPhase === 'act') {
      // Jump to reveal phase without transition
      actVideoEl.pause();
      actVideoEl.style.display = 'none';
      revealCanvas.style.display = 'block';
      fitCanvas();
      currentPhase = 'reveal';
      revealStartTime = null;
      numberOpacity = 1; // Already revealed
      scaleVal = 1;

      function jumpToBoard() {
        const vw = boardVideoEl.videoWidth;
        const vh = boardVideoEl.videoHeight;
        if (vw && vh) { revealCanvas.width = vw; revealCanvas.height = vh; fitCanvas(); }
        boardVideoEl.currentTime = boardT;
        if (!isPaused) boardVideoEl.play();
        cancelAnimationFrame(animFrameId);
        drawReveal();
      }
      if (boardVideoEl.readyState >= 1) jumpToBoard();
      else boardVideoEl.onloadedmetadata = jumpToBoard;
    } else {
      boardVideoEl.currentTime = boardT;
      if (!isPaused) boardVideoEl.play();
    }
  }
  showControls();
}

function exitPerformance() {
  cancelAnimationFrame(animFrameId);
  actVideoEl.pause();
  boardVideoEl.pause();
  actVideoEl.style.display = 'none';
  revealCanvas.style.display = 'none';
  document.getElementById('flashOverlay').style.opacity = '0';
  document.getElementById('tapOverlay').style.display = 'flex';
  document.getElementById('playerControls').style.display = 'none';
  document.getElementById('playerControls').classList.remove('visible');
  document.getElementById('transitionPill').style.display = 'none';
  document.getElementById('scrubber').value = 0;
  document.getElementById('timeDisplay').innerText = '0:00';
  currentPhase = 'act';
  isPaused = false;

  const ps = document.getElementById('performScreen');
  ps.style.display = 'none';
  document.getElementById('setupScreen').style.display = 'block';

  document.exitFullscreen && document.exitFullscreen().catch(()=>{});
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// CANVAS RESIZE ‚Äî keep it filling screen
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function fitCanvas() {
  // Let the canvas scale to fit the screen without stretching
  // Works for both portrait (9:16) and landscape (16:9) videos
  revealCanvas.style.maxWidth   = '100%';
  revealCanvas.style.maxHeight  = '100dvh';
  revealCanvas.style.width      = 'auto';
  revealCanvas.style.height     = 'auto';
  revealCanvas.style.display    = revealCanvas.style.display; // preserve current display value
  revealCanvas.style.position   = 'absolute';
  revealCanvas.style.top        = '50%';
  revealCanvas.style.left       = '50%';
  revealCanvas.style.transform  = 'translate(-50%, -50%)';
}
fitCanvas();
window.addEventListener('resize', fitCanvas);

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// STORAGE MANAGEMENT
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function clearStoredVideos() {
  if (!confirm('Remove saved videos from this device? Your settings will be kept.')) return;
  const tx = db.transaction('videos', 'readwrite');
  tx.objectStore('videos').clear();
  if (actURL)   { URL.revokeObjectURL(actURL);   actURL = null; }
  if (boardURL) { URL.revokeObjectURL(boardURL); boardURL = null; }
  actVideoEl.src  = '';
  boardVideoEl.src = '';
  document.getElementById('actZone').classList.remove('has-file');
  document.getElementById('boardZone').classList.remove('has-file');
  document.getElementById('actBadge').style.display  = 'none';
  document.getElementById('boardBadge').style.display = 'none';
  document.getElementById('boardPreviewWrap').style.display = 'none';
  document.getElementById('storageInfo').innerText = 'Videos cleared.';
  updateDots();
}

async function updateStorageInfo() {
  if (!navigator.storage || !navigator.storage.estimate) return;
  const est = await navigator.storage.estimate();
  const used = est.usage ? (est.usage / (1024*1024)).toFixed(1) : '?';
  const quota = est.quota ? (est.quota / (1024*1024*1024)).toFixed(1) : '?';
  document.getElementById('storageInfo').innerText =
    'Browser storage: ' + used + ' MB used of ' + quota + ' GB available';
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// BOOT
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded', initApp);

// Prevent sleep on iOS/Android during performance
let wakeLock = null;
document.getElementById('performScreen').addEventListener('click', async (e) => {
  // Don't trigger for button clicks inside controls
  if (e.target.closest('#playerControls') || e.target.closest('#tapOverlay') || e.target.closest('#transitionPill')) return;
  showControls();
  if ('wakeLock' in navigator && !wakeLock) {
    try { wakeLock = await navigator.wakeLock.request('screen'); } catch(e2) {}
  }
});
</script>
</body>
</html>
