<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Literal Transcription Lab (Whisper)</title>
    <style>
        body { font-family: -apple-system, sans-serif; background: #F2F2F7; padding: 20px; }
        .transcript-box { background: white; border-radius: 18px; padding: 25px; min-height: 200px; border: 1px solid #D1D1D6; font-size: 19px; line-height: 1.6; }
        .controls { margin-top: 20px; display: flex; flex-direction: column; gap: 10px; }
        .btn { padding: 20px; border-radius: 14px; border: none; font-size: 20px; font-weight: 700; cursor: pointer; }
        .btn-rec { background: #FF3B30; color: white; }
        .btn-stop { background: #007AFF; color: white; display: none; }
        .filler-badge { background: #FF3B30; color: white; padding: 2px 6px; border-radius: 6px; font-weight: 800; font-size: 14px; margin: 0 2px; }
        .status { text-align: center; font-weight: 800; color: #8E8E93; margin-bottom: 10px; }
    </style>
</head>
<body>

    <h1>Whisper Lab v1.0</h1>
    <p>This version uses OpenAI to catch every AH, UM, and repeat.</p>

    <div id="status" class="status">READY</div>
    <div id="output" class="transcript-box">Your literal transcript will appear here...</div>

    <div class="controls">
        <button id="recBtn" class="btn btn-rec" onclick="startRecording()">Start Recording</button>
        <button id="stopBtn" class="btn btn-stop" onclick="stopRecording()">Stop & Transcribe</button>
    </div>

    <script>
        let mediaRecorder;
        let audioChunks = [];
        const aiKey = localStorage.getItem('prod_sdtm_openai_key') || localStorage.getItem('test_sdtm_openai_key');

        async function startRecording() {
            if (!aiKey) { alert("Please add your OpenAI Key in the main app settings first!"); return; }
            
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];

            mediaRecorder.ondataavailable = (event) => audioChunks.push(event.data);
            mediaRecorder.onstop = sendToWhisper;

            mediaRecorder.start();
            document.getElementById('recBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'block';
            document.getElementById('status').innerText = "â— RECORDING...";
            document.getElementById('status').style.color = "#FF3B30";
        }

        function stopRecording() {
            mediaRecorder.stop();
            document.getElementById('status').innerText = "TRANSCRIBING (Wait ~5s)...";
            document.getElementById('status').style.color = "#007AFF";
        }

        async function sendToWhisper() {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            const formData = new FormData();
            formData.append("file", audioBlob, "recording.webm");
            formData.append("model", "whisper-1");
            formData.append("prompt", "Include every um, ah, er, and repetition. Do not clean up the speech.");

            try {
                const response = await fetch("https://api.openai.com/v1/audio/transcriptions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${aiKey}` },
                    body: formData
                });

                const data = await response.json();
                renderLiteralTranscript(data.text);
            } catch (e) {
                document.getElementById('output').innerText = "Error: " + e.message;
            }
            
            document.getElementById('recBtn').style.display = 'block';
            document.getElementById('stopBtn').style.display = 'none';
            document.getElementById('status').innerText = "DONE";
        }

        function renderLiteralTranscript(text) {
            // Highlight fillers specifically for the Grammarian
            const targets = ["UM", "AH", "ER", "UH", "LIKE", "SO", "BUT"];
            let html = text;
            targets.forEach(t => {
                const regex = new RegExp(`\\b${t}\\b`, 'gi');
                html = html.replace(regex, `<span class="filler-badge">$&</span>`);
            });
            document.getElementById('output').innerHTML = html;
        }
    </script>
</body>
</html>
